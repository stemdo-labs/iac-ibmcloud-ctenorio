pipeline {
  agent any
  environment {
    ZAP_API_URL = 'http://zap-service.ctenorio.svc.cluster.local:8099'
    API_URL = 'https://juice-shop.herokuapp.com'
  }
  stages {
    stage('Run ZAP Spider') {
      steps {
        script {
          // Ejecuta el Spider de ZAP para explorar la URL del API
          sh """
          curl "${ZAP_API_URL}/JSON/spider/action/scan/?url=${API_URL}"
          """
        }
      }
    }
    stage('Check Spider Status') {
      steps {
        script {
          // Verifica que el Spider haya terminado
          sh """
          until [ \$(curl -s "${ZAP_API_URL}/JSON/spider/view/status/" | grep -o '100') ]; do
            echo 'Spider is running...'; sleep 5;
          done
          """
        }
      }
    }

    stage('Generate ZAP Report') {
      steps {
        script {
          // Genera un informe utilizando el endpoint de Reports
          sh """
          curl -X GET "${ZAP_API_URL}/JSON/reports/action/generate/?title=${REPORT_TITLE}&template=${REPORT_TEMPLATE}&description=API+Security+Report&contexts=&sites=&sections=&includedConfidences=&includedRisks=&reportFileName=zap_report_\$(date +'%Y%m%d_%H%M%S').html&display="
          """
        }
      }
    }

    stage('Generate ZAP JSON Report') {
      steps {
        script {
          // Genera un reporte JSON utilizando el endpoint de ZAP
          sh """
          curl -X GET "${ZAP_API_URL}/JSON/core/view/alerts/?baseurl=${API_URL}" -o "zap_report_\$(date +'%Y%m%d_%H%M%S').json"
          """
        }
    
  }
}
