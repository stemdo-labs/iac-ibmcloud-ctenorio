pipeline {
    agent {
        kubernetes {
            label 'jenkins-jenkins-agent'
            defaultContainer 'dind'
        }
    }
    parameters {
        string(name: 'TARGET_URL', defaultValue: '', description: 'URL a probar')
    }
    stages {
        stage('Run ZAP Scan') {
            steps {
                script {
                    // Ejecuta ZAP con compatibilidad para sh
                    sh """
                        docker run --rm -v \$(pwd):/zap/wrk:rw zaproxy/zap2docker-stable:latest \
                        zap-full-scan.py -t "$TARGET_URL" -J zap-report.json
                    """
                }
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: 'zap-report.json', fingerprint: true
        }
    }
}
