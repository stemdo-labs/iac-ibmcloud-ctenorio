pipeline {
    agent any
    parameters {
        string(name: 'TARGET_URL', defaultValue: 'https://example.com', description: 'URL a probar')
    }
    environment {
        REPORT_JSON = 'zap-report.json'
        REPORT_HTML = 'zap-report.html'
    }
    stages {
        stage('Run OWASP ZAP') {
            steps {
                script {
                    echo "Ejecutando OWASP ZAP..."
                    sh """
                        docker run --rm \
                        -v ${WORKSPACE}:/zap/wrk:rw \
                        zaproxy/zap2docker-stable:latest zap-baseline.py \
                        -t "${params.TARGET_URL}" \
                        -J /zap/wrk/${REPORT_JSON} \
                        -r /zap/wrk/${REPORT_HTML}
                    """
                }
            }
        }
    }
    post {
        always {
            script {
                echo "Archivando reportes generados..."
                archiveArtifacts artifacts: "${REPORT_JSON}, ${REPORT_HTML}", fingerprint: true
            }
        }
        success {
            echo "OWASP ZAP Scan completado con éxito."
        }
        failure {
            echo "OWASP ZAP Scan detectó problemas."
        }
    }
}
