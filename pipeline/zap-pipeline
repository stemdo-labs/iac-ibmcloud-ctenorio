pipeline {
    agent {
        kubernetes {
            label 'jenkins-jenkins-agent'
            defaultContainer 'dind'
        }
    }
    parameters {
        string(name: 'TARGET_URL', defaultValue: 'https://route-develop-vsanchez.ez-ibm-openshift-vpc-b9be9ed6ae33d743815245d0b773ebc7-0000.eu-es.containers.appdomain.cloud/', description: 'URL a probar')
    }
    environment {
        WORKSPACE_DIR = "${pwd()}" // Directorio actual para reportes
    }
    stages {
        stage('Download OWASP ZAP Docker Image') {
            steps {
                script {
                    // Descarga la imagen de OWASP ZAP
                    sh """
                        docker pull zaproxy/zap-stable
                    """
                }
            }
        }
        stage('Run OWASP ZAP Container') {
            steps {
                script {
                    // Inicia el contenedor en modo demonio
                    sh """
                        docker run -d --name owasp-zap \
                        -v ${WORKSPACE_DIR}:/zap/wrk:rw \
                        owasp/zap2docker-stable /bin/bash
                    """
                }
            }
        }
        stage('Execute ZAP Full Scan') {
            steps {
                script {
                    // Ejecuta el script zap-full-scan.py dentro del contenedor
                    sh """
                        docker exec owasp-zap zap-full-scan.py \
                        -t "${params.TARGET_URL}" \
                        -J /zap/wrk/zap-report.json \
                        -r /zap/wrk/zap-report.html
                    """
                }
            }
        }
    }
    post {
        always {
            script {
                // Detiene y elimina el contenedor después del uso
                sh """
                    docker stop owasp-zap || true
                    docker rm owasp-zap || true
                """
            }
            // Archiva los reportes generados como artefactos
            archiveArtifacts artifacts: '*.json, *.html', fingerprint: true
        }
        success {
            echo "OWASP ZAP Full Scan completado con éxito."
        }
        failure {
            echo "El OWASP ZAP Full Scan detectó problemas."
        }
    }
}
