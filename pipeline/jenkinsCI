pipeline {
    agent any
    parameters {
        // Definir los parámetros equivalentes a inputs en GitHub Actions
        string(name: 'IMAGE_NAME', description: 'Nombre de la imagen Docker', defaultValue: 'prueba')
        string(name: 'VERSION', description: 'Versión de la imagen Docker', defaultValue: '1')
    }
    environment {
        // Definir variables de entorno
        IBM_CLOUD_API_KEY = credentials('IBM_CLOUD_API_KEY')
    }
    stages {
        stage('Descargar Código del Repositorio') {
            steps {
                // Checkout del código fuente
                checkout scm
            }
        }
        stage('Instalar IBM Cloud CLI') {
            steps {
                sh '''
                # Descarga el archivo comprimido del CLI
                curl -fsSL https://clis.cloud.ibm.com/download/bluemix-cli/1.3.2/IBM_Cloud_CLI_1.3.2_amd64.tar.gz -o ibmcloud.tar.gz
                
                # Extrae el contenido en el workspace
                tar -xvf ibmcloud.tar.gz
                
                # Mueve el binario de ibmcloud al workspace
                mv Bluemix_CLI/bin/ibmcloud $WORKSPACE/ibmcloud
                
                # Añade la ruta al PATH temporalmente para este job
                export PATH=$WORKSPACE:$PATH
                
                # Verifica la instalación
                $WORKSPACE/ibmcloud --version
                
                # Limpia los archivos descargados
                rm -rf Bluemix_CLI ibmcloud.tar.gz
                '''
                }
            }

        stage('Verificar IBM Cloud CLI') {
            steps {
                sh 'ibmcloud --version'
            }
        }


/*
       
        stage('Instalar IBM Cloud Container Registry Plugin') {
            steps {
                sh 'ibmcloud plugin install container-registry'
            }
        }
        stage('Debug IBM Cloud Login Inputs') {
            steps {
                echo "API Key: ${env.IBM_CLOUD_API_KEY}" 
            }
        }
        stage('Login to IBM Cloud') {
            steps {
                sh 'ibmcloud login --apikey ${IBM_CLOUD_API_KEY} -r eu-gb'
            }
        }
        stage('Target Resource Group') {
            steps {
                sh 'ibmcloud target -g Stemdo_Sandbox'
            }
        }
        stage('Configurar IBM Cloud Container Registry') {
            steps {
                script {
                    sh '''
                    ibmcloud cr login
                    ibmcloud cr namespace-add ctenorio-cr
                    '''
                }
            }
        }


      #DOCKER
    stage('Instalar Docker') {
            steps {
                script {
                    sh '''
                        # Add Docker's official GPG key:
                        apt-get update
                        apt-get install -y ca-certificates curl
                        install -m 0755 -d /etc/apt/keyrings
                        curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
                        chmod a+r /etc/apt/keyrings/docker.asc
 
                        # Add the repository to Apt sources:
                        echo \
                            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
                            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                            tee /etc/apt/sources.list.d/docker.list > /dev/null
                        apt-get update
 
                        apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                    '''
                }
            }
        }
    
        stage('Construir y Publicar la Imagen Docker') {
            steps {
                script {
                    sh """
                    docker build -t uk.icr.io/ctenorio-cr/${params.IMAGE_NAME}:${params.VERSION} .
                    docker push uk.icr.io/ctenorio-cr/${params.IMAGE_NAME}:${params.VERSION}
                    """
                }
            }
        }
        */
    }
}
